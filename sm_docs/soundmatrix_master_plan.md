# Toptea SoundMatrix - 门店背景音乐分发系统架构书

**版本：** 1.2
**更新日期：** 2025-11-22
**项目代号：** SoundMatrix (音阵)

## 1. 项目概述
SoundMatrix 是 Toptea 专用的门店背景音乐自动化管理系统。
核心目标是实现“总部统一制定策略，门店终端离线自动执行”，确保品牌听觉体验的一致性。

## 2. 核心原则 (Key Principles)
1.  **离线优先 (Offline First):** 终端必须在断网情况下能正常工作至少 30 天。
2.  **数据同源:** 与 `toptea-cpsys` 共享数据库，但代码库独立。
3.  **设备准入制 (Device Approval):** 采用“先连接、后审批”的白名单机制，拒绝陌生设备获取资源。
4.  **不死鸟播放 (Unkillable Playback):** 采用 Android 前台服务 + 唤醒锁机制，确保熄屏和后台运行时音乐不中断。

## 3. 安全与设备管理策略 (Security & Devices)

为了避免复杂的账号密码管理，同时防止恶意连接：

* **默认拒绝 (Default Deny):** 任何新设备首次连接 API 时，服务器记录其 MAC 地址，但默认标记为 **“未激活” (Status=0)**，并拒绝下发数据。
* **后台审批:** 管理员在后台“设备监控”页面，确认设备归属（绑定门店）并点击“激活”。
* **自动认领:** 设备一旦被激活，永久自动获取对应门店的播放策略，无需再次认证。
* **API 密钥防护:** 所有客户端请求必须在 Header 中携带 `X-Toptea-Secret` 密钥，作为第一道防火墙。

## 4. 业务逻辑与优先级 (Priority Logic)

安卓终端判断“当前应该播放什么”时，必须严格遵循以下**三级优先级**倒序检查：


* **Level 1: 特例活动 (Special Events) [最高优先级]**
    * **定义:** 指定绝对日期范围（如 `2025-12-24` ~ `2025-12-25`）。
    * **场景:** 圣诞节、双十一、店庆。
    * **行为:** 一旦当前日期命中，无视星期几和节假日设定，强制执行此策略。

* **Level 2: 法定节假日 (Public Holidays) [中等优先级]**
    * **定义:** 基于日历标签（如 `is_holiday = true`）。
    * **场景:** 国庆、春节、劳动节（包含调休导致的非周末休息日）。
    * **行为:** 若未命中 Level 1，且当前日期在日历表中被标记为红日，执行此策略。

* **Level 3: 周循环 (Weekly Routine) [基础优先级]**
    * **定义:** 基于星期几（Mon-Sun）。
    * **场景:** 日常营业。
    * **行为:** 若未命中 Level 1 和 Level 2，根据今天是星期几，执行对应策略（如：周末歌单 vs 工作日歌单）。

## 5. 安卓端保活策略 (Android Keep-Alive)

为了防止 Android 系统在熄屏或切换应用时杀掉播放进程：

1.  **前台服务 (Foreground Service):** App 启动播放时，必须注册前台服务，并在通知栏常驻显示“Toptea BGM 正在运行”，提升进程优先级至最高。
2.  **CPU 唤醒锁 (Partial WakeLock):** 播放期间申请 CPU 锁，允许屏幕关闭但强迫 CPU 保持运转，防止解码中断。
3.  **忽略电池优化:** 首次启动引导用户将 App 加入电池优化白名单。

## 6. 文件存储规范
* MP3 文件存储在云端 (OSS/S3) 或本地服务器上传目录。
* 安卓端下载后，文件名建议重命名为 MD5 值（如 `a1b2c3d4.mp3`）以避免重复下载。


战局总览 (Status Report)
截止目前（2025-11-22），SoundMatrix 项目进度如下：

后端 (Backend): ✅ 已竣工

API 接口、后台管理、数据库均已上线 (hqv3.toptea.es/smsys)。

随时准备向安卓端输送数据。

安卓端 (Android Client): 🔄 正在初始化

项目架构: com.toptea.tbm 已建立。

军火库 (Gradle): Retrofit, Room, ExoPlayer 依赖已配置。

权限 (Manifest): 不死鸟权限（前台服务、唤醒锁）已申请。

网络 (Network Security): HTTP 白名单文件已创建（这是刚才卡住的地方）。

🚀 下一步主攻方向：Phase 3 - Step 2 (数据层构建)
我们现在的目标非常明确：让安卓手机拥有“记忆”。

它需要一个本地数据库（SQLite/Room），结构必须跟服务器端的 MySQL 对应，这样它才能把服务器发来的歌单和策略“记在本子上”，断网了也能照着本子播放。

我们不再纠结配置文件的创建细节（假设您上一步已经 Build 成功），直接开始写 Kotlin 代码。