# Toptea SoundMatrix - Phase 2.5 后端代码审计报告

**审计日期**: 2025-11-23
**审计对象**: 后端系统代码 (hq_html/sm_app)
**审计人**: Gemini (SQA & ISA)
**审计结论**: ⚠️ 有条件通过 (Conditional Pass) - 存在严重安全隐患，需修复后才可上线

---

## 1. 审计综述 (Executive Summary)

本次审计针对 Phase 2.5 阶段提交的 PHP 后端代码及 MySQL 数据库结构进行了全量核查。审计基准为《需求规格说明书》及《系统设计方案》。

总体而言，核心业务逻辑（如策略分发、版本控制、API 数据结构）实现完整，代码风格统一。

**关键发现：**
虽然 API 接口层面的安全机制（鉴权、设备准入）已落实，但**后台管理系统 (Admin UI) 存在致命的安全缺失**，即缺乏用户登录与身份验证机制。此外，策略排期逻辑缺乏必要的冲突校验。

---

## 2. 需求吻合度审核 (Compliance Audit)

以下功能模块经代码审查，确认与需求文档一致：

### 2.1 API 安全鉴权 (Passed)
* **代码位置**: `ApiController.php` 中的 `verifyApiSecret` 方法。
* **验证结果**: 确实实现了强制的 Header 检查。若请求头中缺失 `X-Toptea-Secret` 或密钥不匹配，系统会直接终止执行并返回 HTTP 403 状态码。这符合 B-001 任务要求。

### 2.2 设备准入控制 (Passed)
* **代码位置**: `ApiController.php` 中的 `check_update` 和 `getOrRegisterDevice` 方法。
* **验证结果**: 新设备接入时，数据库状态默认设为 0 (待激活)。接口逻辑明确拦截了状态为 0 (未激活) 和 2 (禁用) 的设备请求，仅允许状态为 1 的设备获取配置。符合安全设计原则。

### 2.3 多级策略分发 (Passed)
* **代码位置**: `ApiController.php` 中的 `fetchAssignments` 方法。
* **验证结果**: 代码正确实现了“特例 (Priority 3) > 节假日 (Priority 2) > 周循环 (Priority 1)”的逻辑。返回给客户端的 JSON 结构清晰地分离了这三个层级，便于客户端进行本地计算。

### 2.4 版本号计算机制 (Passed)
* **代码位置**: `ApiController.php` 中的 `check_update` 方法。
* **验证结果**: 系统使用 `UNION ALL` 聚合查询了指派表、歌单表和策略表的最大更新时间。这意味着无论管理员修改了哪种配置，版本号都会发生变化，从而触发客户端更新。

---

## 3. 严重缺陷与遗漏 (Critical Deficiencies)

以下问题属于 **P0 级阻断项**，必须在生产环境部署前修复：

### 🔴 3.1 后台管理系统缺乏身份验证 (Missing Admin Authentication)
* **严重程度**: **极高 (Critical)**
* **问题描述**: 尽管数据库脚本 (`sm_db_schema_structure_only.sql`) 中创建了 `cpsys_users` 表，但在 PHP 代码层面，`BaseController.php` 及所有继承它的控制器（如 `DevicesController`, `SongsController`）中，**完全没有实现登录检查 (Session Check) 或重定向逻辑**。
* **风险后果**: 任何外部人员只要猜到后台 URL（例如 `/smsys/devices/index`），即可直接访问管理界面，执行删除设备、修改策略等高危操作。系统处于“裸奔”状态。
* **修复建议**: 立即在 `BaseController` 的构造函数中添加 Session 验证逻辑，若未登录则重定向至登录页。

### 🔴 3.2 策略时间轴缺乏冲突校验 (Time Slot Overlap)
* **严重程度**: **高 (High)**
* **问题描述**: 在 `StrategiesController.php` 的 `save` 方法中，后端直接接收前端提交的时间段数组并存为 JSON，未进行任何逻辑校验。
* **风险后果**: 管理员可能误操作设置了重叠的时间段（例如：08:00-12:00 和 10:00-14:00）。这将导致客户端在重叠时段（10:00-12:00）无法确定播放哪个歌单，引发逻辑混乱或崩溃。
* **修复建议**: 在保存数据前，必须在服务端遍历时间段，确保任意两个时间段之间不存在交集。

---

## 4. 代码质量与改进建议 (Code Quality & Improvements)

以下问题属于 **P1/P2 级优化项**，建议在下一版本中改进：

### 🟠 4.1 URL 生成协议风险
* **代码位置**: `SongsController.php` 第 140 行。
* **问题**: 文件上传成功后，生成的文件 URL 硬编码了 `http://` 前缀。
* **建议**: 现代安卓系统（Android 9+）默认禁止明文流量。如果服务器部署了 SSL 证书，这里生成的 URL 仍然是 HTTP，会导致客户端下载失败。建议根据 `$_SERVER['HTTPS']` 动态判断，或使用相对协议头。

### 🟠 4.2 MP3 时长解析鲁棒性
* **代码位置**: `SongsController.php` 中的 `getMp3Duration` 方法。
* **问题**: 纯 PHP 解析逻辑仅支持 CBR (固定码率) 格式。如果上传 VBR (可变码率) 的 MP3 文件且服务器未安装 FFmpeg，计算出的时长将严重失真。
* **建议**: 在上传界面增加提示，或在数据库中增加标记，允许管理员手动修正时长。

### 🔵 4.3 缺乏操作审计日志
* **问题**: 虽然文档中提到了“日志审计”，但当前代码并未记录管理员的关键操作（如谁删除了歌单、谁激活了设备）。
* **建议**: 建立一张 `sm_admin_logs` 表，记录关键操作的时间、IP 和操作人。

---

## 5. 审计总结

本次交付的后端代码在核心业务逻辑（API 通信、数据结构）上是合格的，能够支撑 Android 客户端的开发与联调。

**但是，由于后台管理界面完全缺失身份验证，该系统目前严禁发布到公网环境。**

**下一步行动计划 (Action Items):**
1.  **立即修复**: 在 `BaseController.php` 中补全登录鉴权逻辑。
2.  **立即修复**: 在 `StrategiesController.php` 中增加时间轴重叠校验。
3.  **后续优化**: 修正 HTTP/HTTPS 协议生成的兼容性问题。

**审计状态**: 🔴 **REJECTED (需修复 P0 问题后复审)**